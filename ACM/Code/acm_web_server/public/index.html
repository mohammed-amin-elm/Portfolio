<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ACM | Control Enviroment</title>

    <style>
        :root {
            --header-top: -10px;
        }

        body {
            font-family: Arial;
            margin: 0;
            overflow: hidden;
        }
        header {
            height: 100px;
            border-bottom: solid 2px #2B2D42;
        }
        #acm-container {
            background-color: #2B2D42;
            color: #fff;
            display: inline-block;
            padding: 50px;
            margin: 0;
            height: 0px;
            width: 10%;
            text-align: center;
        }
        #acm-container span {
            position: relative;
            top: var(--header-top);
            font-size: 21px;
            font-weight: bold;
        }
        #ci-container {
            display: inline-block;
            text-align: center;
            width: 70%;
        }
        #ci-container span{
            position: relative;
            top: var(--header-top);
            font-size: 21px;
            font-weight: bold;
        }
        .blocks {
            width: 25%;
            height: 450px;
            border: solid 1px black;
            border-radius: 10px;
            display: inline-block;
            margin-right: 15px;
            margin-left: 15px;
            position: relative;
            top: 3vh;
            overflow: hidden;
        }
        .blocks h3 {
            margin-bottom: 15px;
        }
        .block-header {
            background-color: #2B2D42;
            color: #fff;
            padding: 10px;
        }
        .block-header span {
            font-weight: bold;
        }
        #system-button {
            height: 40px;
            width: 40%;
            font-size: 25px;
            font-weight: bold;
            background-color: #fc4138;
            border: none;
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            transition: 0.5s;
            appearance: nonex;
        }
        .control-input {
            width: 30%;
            height: 20px;
        }
        hr {
            background-color: black;
            margin-top: 20px;
        }
        #base {
            position: relative;
            width: 100px;
            height: 150px;
            border: solid 1px black;
            top: -90px;
        }
        .wheel {
            width: 20px;
            height: 50px; 
            border: solid 1px black;
        }
        #wheel1 {
            position: relative;
            left: 61px;
            top: 21px;
        }
        #wheel2 {
            position: relative;
            left: -61px;
            top: -30px;
        }
        #wheel3 {
            position: relative;
            left: -61px;
            top: -155px;
        }
        #wheel4 {
            position: relative;
            left: 61px;
            top: -206px;
        }
        .circle {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-block;
            background-color: #fc4138;
            position: relative;
            top: 2px;
        }
        .ir-container {
            margin: 10px;
        }
        table th {
            width: 15%;
        }
        .row-text {
            text-align: left;
        }
        .row-status {
            text-align: right;
        }

        .parameter-submit {
            height: 40px;
            width: 50%;
            font-size: 18px;
            background-color: #2B2D42;
            color: #fff;
            border: solid 1px #2B2D42;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 12.5px;
        }

        @media only screen and (max-width: 600px) {
            body {
                overflow: scroll;
            }

            .blocks {
                width: 75%;
                display: block;
                margin: 15px;
            }
            #ci-container {
                width: 50%;
            }
        }
    </style>
</head>
<body>
    <div class='container'>
        <header>
            <div id='acm-container'>
                <span>ACM</span>
            </div>
            <div id='ci-container'>
                <span>Control Interface</span>
            </div>
        </header>
        <section>
            <center>
                <div class='blocks' id='control'>
                    <div class='block-header'>
                        <span>Control</span>
                    </div>
                    <h3>System</h3>
                    <button id='system-button'>OFF</button>
                    <hr>

                    <h3>Turn Delay</h3>
                    <input id='turn-delay-input' class='control-input' type='number' min='0' max='7000' placeholder='0 - 7000 (ms)' oninput='setEqual(this, document.querySelector(`#turn-delay-range`), 0, 7000)'>
                    <input id='turn-delay-range' type='range' min='0' max='7000' value='750' oninput='setEqual(this, document.querySelector(`#turn-delay-input`), 0, 7000)'>
                    <hr>


                    <h3>Obstacle Threshold</h3>
                    <input id='obstacle-input' class='control-input' type='number' min='0' max='30' placeholder='0 - 30 (cm)' oninput='setEqual(this, document.querySelector(`#obstacle-range`), 0, 7000)'>
                    <input id='obstacle-range' type='range' min='0' max='30' value='3' oninput='setEqual(this, document.querySelector(`#obstacle-input`), 0, 30)'>
                    <hr>

                    <button id='data-submit' class='parameter-submit'>Submit</button>
                </div>
                <div class='blocks'>
                    <div class='block-header'>
                        <span>Motors</span>
                    </div>

                    <h3>Motor  Speed</h3>
                    <input id='speed-input' class='control-input' type='number' min='0' max='255' placeholder='0 - 255' oninput='setEqual(this, document.querySelector(`#speed-range`), 0, 255)'>
                    <input id='speed-range' type='range' min='0' max='255' value='255' oninput='setEqual(this, document.querySelector(`#speed-input`), 0, 255)'>
                    <hr>

                    <h3>Motor Layout</h3>
                    <div class='car'>
                        <div class='wheel' id='wheel1'></div>
                        <div class='wheel' id='wheel2'></div>
                        <div id='base'></div>
                        <div class='wheel' id='wheel3'></div>
                        <div class='wheel' id='wheel4'></div>
                    </div>
                </div>
                <div class='blocks'>
                    <div class='block-header'>
                        <span>Sensors</span>
                    </div>

                    <div id='ir-sensors'>
                        <h3>IR Sensors</h3>
                        <hr>
                        <table>
                            <tr>
                                <th class='row-text'>Left</th>
                                <th class='row-status'><div class='circle' id='ir-left'></div></th>
                            </tr>
                            <tr>
                                <th class='row-text'>Front</th>
                                <th class='row-status'><div class='circle' id='ir-front'></div></th>
                            </tr>
                            <tr>
                                <th class='row-text'>Right</th>
                                <th class='row-status'><div class='circle' id='ir-right'></div></th>
                            </tr>
                        </table>
                    </div>
                    <hr>

                    <div id='ultrasonic-sensor-container'>
                        <h3>Ultrasonic Distance Sensor</h3>
                        <hr>
                        <table>
                            <tr>
                                <th class='row-text'>Front</th>
                                <th class='row-status'><span id='us-value'></span>cm</th>
                            </tr>
                        </table>
                        <hr>
                    </div>
                </div>
            </center>
        </section>
    </div>

    <script>
        var Socket;

        function init() {
            Socket = new WebSocket('ws://' + window.location.hostname + ':8080/');
            Socket.onmessage = (event) => {
                if(event.data == 'TOO_MANY_CLIENTS') {
                    alert('Another client is already using the interface!');
                } else if(event.data == 'SUCCESS_ON') {
                    system_btn.style.backgroundColor = '#53ff40';
                    system_btn.innerHTML = 'ON';
                } else if(event.data == 'SUCCESS_OFF') {
                    system_btn.style.backgroundColor = '#fc4138';
                    system_btn.innerHTML = 'OFF';
                } else if(event.data == 'SUCCESS_DATA') {
                    alert('Parameters have been succesfully updated!');
                } else {
                    let obj = JSON.parse(event.data);
                    updateSensors(obj);
                    updateMotors(obj);
                }
            };
        }

        window.onload = () => {
            init();
        };

        let system_btn = document.querySelector('#system-button');
        system_btn.addEventListener('click', () => {
            
            if(system_btn.innerHTML == 'ON') {
                Socket.send('OFF');
            } else {
                Socket.send('ON');
            }
        });

        let submit_btn = document.querySelector('#data-submit');
        submit_btn.addEventListener('click', () => {
            let delay_input = document.querySelector('#turn-delay-input');
            let obstacle_input = document.querySelector('#obstacle-input');
            let speed_input = document.querySelector('#speed-input');

            if(!delay_input.value || !obstacle_input.value || !speed_input.value) {
                alert('Empty fields are not allowed!');
            } else {
                let obj = {
                    delay_input: delay_input.value,
                    obstacle_input: obstacle_input.value,
                    speed_input: speed_input.value
                };
                let json_obj = JSON.stringify(obj);
                Socket.send(json_obj);
                alert('Parameters have been send to the ESP32!');
            }
        });

        function setEqual(el1, el2, min, max) {
            if(el1.value < min) {
                el1.value = min;
            } else if(el1.value > max) {
                el1.value = max;
            }
            el2.value = el1.value;
        }

        function updateSensors(obj) {
            document.querySelector('#us-value').innerHTML = obj.obstacle;
            if(obj.ir1 == 1) {
                document.querySelector('#ir-left').style.backgroundColor = '#53ff40';
            } else {
                document.querySelector('#ir-left').style.backgroundColor = '#fc4138';
            }
            if(obj.ir2 == 1) {
                document.querySelector('#ir-front').style.backgroundColor = '#53ff40';
            } else {
                document.querySelector('#ir-front').style.backgroundColor = '#fc4138';
            }
            if(obj.ir3 == 1) {
                document.querySelector('#ir-right').style.backgroundColor = '#53ff40';
            } else {
                document.querySelector('#ir-right').style.backgroundColor = '#fc4138';
            }
        }

        function updateMotors(obj) {
            if(obj.motor1 == 1) {
                document.querySelector('#wheel1').style.backgroundColor = '#fc4138';
            } else {
                document.querySelector('#wheel1').style.backgroundColor = '#ffffff';
            }
            if(obj.motor2 == 1) {
                document.querySelector('#wheel2').style.backgroundColor = '#fc4138';
            } else {
                document.querySelector('#wheel2').style.backgroundColor = '#ffffff';
            }
            if(obj.motor3 == 1) {
                document.querySelector('#wheel3').style.backgroundColor = '#fc4138';
            } else {
                document.querySelector('#wheel3').style.backgroundColor = '#ffffff';
            }
            if(obj.motor4 == 1) {
                document.querySelector('#wheel4').style.backgroundColor = '#fc4138';
            } else {
                document.querySelector('#wheel4').style.backgroundColor = '#ffffff';
            }
        }
    </script>
</body>
</html>